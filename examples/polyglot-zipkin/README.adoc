= Example Polyglot Application

Example applications demonstrating polyglot environment instrumented with zipkin instrumentation libraries.

[[architecture]]
image::architecture.png[Architecture]

Architecture diagram shows dependencies between services. The whole environment
can be executed with docker-compose. Some of the services can be used in standalone mode, however some
of the endpoints might not work as they are calling external services. Feel free to experiment and add new endpoints or
services.

== Run
Before running ensure that containers from previous run were removed.

[source,shell]
----
$ export KAFKA_ZOOKEEPER=172.17.0.1
$ export TRACING_SERVER=172.17.0.1
$ export TRACING_PORT=8080

$ docker-compose pull
$ docker-compose up
$ docker-compose down -> stop and remove all containers

-> Run tracing server (Hawkular APM or zipkin server). Server has to be started after containers to make sure kafka service is running.
-> If using Hawkular APM use bin/standalone.sh -b 0.0.0.0 -Djboss.http.port=8080.
----

* `TRACING_SERVER` - address of tracing server. It cannot be localhost,
                     therefore bind tracing server to `0.0.0.0` address or `172.17.0.1` (docker0 interface).
* `TRACING_PORT` - port of the tracing server. Hawkular APM 8080 or zipkin 9411.
* `KAFKA_ZOOKEEPER` - enables kafka consumer in APM and Zipkin server. It should be an address of the machine with docker engine.

== Example requests
[source,shell]
----
$ curl -ivX GET 'http://localhost:3001/nodejs/hello'
$ curl -ivX GET 'http://localhost:3000/dropwizard/hello'
$ curl -ivX GET 'http://localhost:3003/wildfly-swarm/hello'
$ curl -ivX GET 'http://localhost:3002/roda/hello'
$ curl -ivX GET 'http://localhost:3004/pyramid/hello'
-> hello calls

$ curl -ivX POST -H 'Content-Type: application/json' 'http://localhost:3001/nodejs/createUser' -d '{"name": "jdoe"}'
-> multi service call for user creation
$ curl -ivX POST -H 'Content-Type: application/json' 'http://localhost:3000/dropwizard/users' -d '{"name": "jdoe"}'
$ curl -ivX GET 'http://localhost:3000/dropwizard/users'
-> create and get users in dropwizard (using MySQL)
$ curl -ivX POST -H 'Content-Type: application/json' 'http://localhost:3003/wildfly-swarm/users' -d '{"name": "jdoe"}'
$ curl -ivX GET 'http://localhost:3003/wildfly-swarm/users'
-> create and get users in wildfly-swarm (using Cassandra)
$ curl -ivX GET 'http://localhost:3000/dropwizard/asyncTwoOutgoingCalls'
-> asynchronous call
$ curl -ivX GET 'http://localhost:3000/dropwizard/A'
-> chaining requests within one service
$ curl -ivX GET 'http://localhost:3004/pyramid/loop'
-> chaining requests within one service
----

== Screenshots
image::hawkular-apm-createUser.png[Hawkular APM UI, createUser, height="300", width="800"]
{nbsp}

image::hawkular-apm-createUser-detail.png[Hawkular APM UI, createUser, height="300", width="800"]
{nbsp}

image::zipkin-createUser.png[Zipkin UI, createUser, height="300", width="800"]

== Known issues
* https://issues.jboss.org/browse/HWKAPM-623[Span from ruby app fail to deserialize in zipkin server]
* https://issues.jboss.org/browse/HWKAPM-689[zipkin-js instrumentation does not send all client spans]
