{
  "instrumentation": {
    "org.apache.http.client": {
      "description": "Apache HttpClient instrumentation",
      "rules": [{
        "ruleName": "Apache HttpClient Producer Start",
        "className": "^org.apache.http.impl.client.CloseableHttpClient",
        "methodName": "doExecute",
        "parameterTypes": [
          "*"
        ],
        "location": "ENTRY",
        "condition": "activate($2.getRequestLine().getUri())",
        "binds": [{
          "name": "id",
          "type": "java.lang.String",
          "expression": "createUUID()"
        }],
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Request",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$2.getRequestLine().getUri()",
          "idExpression": "id"
        },{
          "type": "ProcessHeaders",
          "direction": "Request",
          "originalType": "org.apache.http.HttpMessage",
          "headersExpression": "$2"
        },{
          "type": "SetDetail",
          "name": "btm_source",
          "valueExpression": "\"org.apache.http.client\""
        },{
          "type": "SetDetail",
          "name": "http_method",
          "valueExpression": "$2.getRequestLine().getMethod()"
        },{
          "type": "FreeFormAction",
          "action": "$2.setHeader(\"Hawkular-btid\",id)"
        },{
          "type": "FreeFormAction",
          "action": "$2.setHeader(\"Hawkular-btname\",getBusinessTransactionName())"
        }]
      },{
        "ruleName": "Apache HttpClient Producer Write Request",
        "className": "^org.apache.http.impl.client.CloseableHttpClient",
        "methodName": "doExecute",
        "parameterTypes": [
          "*"
        ],
        "binds": [{
          "name": "req",
          "type": "org.apache.http.client.methods.HttpEntityEnclosingRequestBase",
          "expression": "cast($2,org.apache.http.client.methods.HttpEntityEnclosingRequestBase.class)"
        }],
        "location": "ENTRY",
        "condition": "isActive() && isRequestContentProcessed() && req != null",
        "actions": [{
          "type": "ProcessContent",
          "direction": "Request",
          "valueExpressions": [
            "org.apache.http.util.EntityUtils.toString(req.getEntity())"
          ]
        }]
      },{
        "ruleName": "Apache HttpClient Producer Check Fault",
        "className": "^org.apache.http.message.BasicHttpResponse",
        "methodName": "<init>",
        "parameterTypes": [
          "org.apache.http.StatusLine",
          "org.apache.http.ReasonPhraseCatalog",
          "java.util.Locale"
        ],
        "location": "ENTRY",
        "condition": "isActive() && $1.getStatusCode() != 200",
        "actions": [{
          "type": "SetFault",
          "nameExpression": "$1.getStatusCode()",
          "descriptionExpression": "$1.getReasonPhrase()"
        }]
      },{
        "ruleName": "Apache HttpClient Producer Check Fault Or No Content End",
        "className": "^org.apache.http.message.BasicHttpResponse",
        "methodName": "<init>",
        "parameterTypes": [
          "org.apache.http.StatusLine",
          "org.apache.http.ReasonPhraseCatalog",
          "java.util.Locale"
        ],
        "location": "ENTRY",
        "condition": "isActive() && ($1.getStatusCode() != 200 || !isResponseContentProcessed())",
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Response",
          "endpointTypeExpression": "\"HTTP\""
        }]
      },{
        "ruleName": "Apache HttpClient Producer Write Response",
        "className": "^org.apache.http.entity.BasicHttpEntity",
        "methodName": "getContent",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && isResponseContentProcessed()",
        "actions": [{
          "type": "FreeFormAction",
          "action": "$! = createResponseInputStream($!)"
        }]
      },{
        "ruleName": "Apache HttpClient Producer Write Close",
        "className": "^org.apache.http.impl.io.ContentLengthInputStream",
        "methodName": "close",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "isActive() && isResponseContentProcessed()",
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Response",
          "endpointTypeExpression": "\"HTTP\""
        }]
      }]
    }
  }
}