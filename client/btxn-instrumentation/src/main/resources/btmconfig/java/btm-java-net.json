{
  "instrumentation": {
    "java.net": {
      "description": "Java HttpUrlConnection instrumentation",
      "rules": [{
        "ruleName": "Java HttpUrlConnection connect Producer Start",
        "className": "^java.net.HttpURLConnection",
        "methodName": "connect",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "!$0.connected && activate($0.getURL().toString()) && !callerMatches(\"HttpURLConnection.*\",true)",
        "binds": [{
          "name": "id",
          "type": "java.lang.String",
          "expression": "createUUID()"
        }],
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Request",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$0.getURL().toString()",
          "idExpression": "id"
        },{
          "type": "ProcessHeaders",
          "direction": "Request",
          "headersExpression": "$0.getRequestProperties()"
        },{
          "type": "SetDetail",
          "name": "btm_source",
          "valueExpression": "\"java.net\""
        },{
          "type": "SetDetail",
          "name": "http_method",
          "valueExpression": "$0.getRequestMethod()"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btid\",id)"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btname\",getBusinessTransactionName())"
        },{
          "type": "InitiateLink",
          "idExpression": "\"java.net-async-\"+hashCode($0)"
        },{
          "type": "Unlink"
        }]
      },{
        "ruleName": "Java HttpUrlConnection getOutputStream Producer Start",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getOutputStream",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "!$0.connected && activate($0.getURL().toString())",
        "binds": [{
          "name": "id",
          "type": "java.lang.String",
          "expression": "createUUID()"
        }],
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Request",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$0.getURL().toString()",
          "idExpression": "id"
        },{
          "type": "ProcessHeaders",
          "direction": "Request",
          "headersExpression": "$0.getRequestProperties()"
        },{
          "type": "SetDetail",
          "name": "btm_source",
          "valueExpression": "\"java.net\""
        },{
          "type": "SetDetail",
          "name": "http_method",
          "valueExpression": "$0.getRequestMethod()"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btid\",id)"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btname\",getBusinessTransactionName())"
        }]
      },{
        "ruleName": "Java HttpUrlConnection getOutputStream Producer Init Buffer",
        "notes": [
          "The actual written data will be captured using the java.io instrumentation rules"
        ],
        "className": "^java.net.HttpURLConnection",
        "methodName": "getOutputStream",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && isRequestContentProcessed()",
        "actions": [{
          "type": "FreeFormAction",
          "action": "$! = createRequestOutputStream($!,\"java.net-async-\"+hashCode($0))"
        }]
      },{
        "ruleName": "Java HttpUrlConnection getOutputStream Producer Init Link",
        "notes": [
          "The actual written data will be captured using the java.io instrumentation rules"
        ],
        "className": "^java.net.HttpURLConnection",
        "methodName": "getOutputStream",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && !isRequestContentProcessed()",
        "actions": [{
          "type": "InitiateLink",
          "idExpression": "\"java.net-async-\"+hashCode($0)"
        },{
          "type": "Unlink"
        }]
      },{
        "ruleName": "Java HttpUrlConnection getInputStream Producer Start",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getInputStream",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "!$0.connected && !callerMatches(\"HttpURLConnection.*\",true) && activate($0.getURL().toString())",
        "binds": [{
          "name": "id",
          "type": "java.lang.String",
          "expression": "createUUID()"
        }],
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Request",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$0.getURL().toString()",
          "idExpression": "id"
        },{
          "type": "ProcessHeaders",
          "direction": "Request",
          "headersExpression": "$0.getRequestProperties()"
        },{
          "type": "SetDetail",
          "name": "btm_source",
          "valueExpression": "\"java.net\""
        },{
          "type": "SetDetail",
          "name": "http_method",
          "valueExpression": "$0.getRequestMethod()"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btid\",id)"
        },{
          "type": "FreeFormAction",
          "action": "$0.setRequestProperty(\"Hawkular-btname\",getBusinessTransactionName())"
        }]
      },{
        "ruleName": "Java HttpUrlConnection Producer End Complete Async Link",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getResponseCode",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "isLinkActive(\"java.net-async-\"+$0.hashCode())",
        "actions": [{
          "type": "CompleteLink",
          "idExpression": "\"java.net-async-\"+$0.hashCode()"
        }]
      },{
        "ruleName": "Java HttpUrlConnection Producer End Unsuccessful",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getResponseCode",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && $! != 200",
        "actions": [{
          "type": "SetFault",
          "nameExpression": "$!",
          "descriptionExpression": "$0.responseMessage"
        },{
          "type": "InstrumentProducer",
          "direction": "Response",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$0.getURL().toString()"
        }]
      },{
        "ruleName": "Java HttpUrlConnection Producer End Success No Content Required",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getResponseCode",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && $! == 200 && (!isResponseContentProcessed() || !$0.getDoOutput())",
        "actions": [{
          "type": "InstrumentProducer",
          "direction": "Response",
          "endpointTypeExpression": "\"HTTP\"",
          "uriExpression": "$0.getURL().toString()"
        }]
      },{
        "ruleName": "Java HttpUrlConnection HttpInputStream Complete Async Link",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getInputStream",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isLinkActive(\"java.net-async-\"+$0.hashCode()) && $0.responseCode == 200 && !callerMatches(\"HttpURLConnection.*\",true)",
        "actions": [{
          "type": "CompleteLink",
          "idExpression": "\"java.net-async-\"+$0.hashCode()"
        }]
      },{
        "ruleName": "Java HttpUrlConnection HttpInputStream init",
        "className": "^java.net.HttpURLConnection",
        "methodName": "getInputStream",
        "parameterTypes": [
        ],
        "location": "EXIT",
        "condition": "isActive() && $0.responseCode == 200 && !callerMatches(\"HttpURLConnection.*\",true)",
        "actions": [{
          "type": "FreeFormAction",
          "action": "initResponseBuffer(null)"
        }]
      },{
        "ruleName": "Java HttpUrlConnection HttpInputStream read 1",
        "className": "sun.net.www.protocol.http.HttpURLConnection$HttpInputStream",
        "methodName": "read",
        "parameterTypes": [
          "byte[]"
        ],
        "location": "EXIT",
        "condition": "isResponseBufferActive(null) && $! != -1",
        "actions": [{
          "type": "FreeFormAction",
          "action": "appendResponseBuffer(null,$1,0,$!,false)"
        }]
      },{
        "ruleName": "Java HttpUrlConnection HttpInputStream read 2",
        "className": "sun.net.www.protocol.http.HttpURLConnection$HttpInputStream",
        "methodName": "read",
        "parameterTypes": [
          "byte[]",
          "int",
          "int"
        ],
        "location": "EXIT",
        "condition": "isResponseBufferActive(null) && $! != -1",
        "actions": [{
          "type": "FreeFormAction",
          "action": "appendResponseBuffer(null,$1,$2,$!,false)"
        }]
      },{
        "ruleName": "Java HttpUrlConnection HttpInputStream close",
        "className": "sun.net.www.protocol.http.HttpURLConnection$HttpInputStream",
        "methodName": "close",
        "parameterTypes": [
        ],
        "location": "ENTRY",
        "condition": "isResponseBufferActive(null)",
        "actions": [{
          "type": "FreeFormAction",
          "action": "recordResponseBuffer(null)"
        },{
          "type": "InstrumentProducer",
          "direction": "Response",
          "endpointTypeExpression": "\"HTTP\""
        }]
      }]
    }
  }
}